import streamlit as st 
from functools import lru_cache
import numpy as np
import pandas as pd
import .config as cf
import .designer_dna 
import .preprocess as pp
import .recommender as rc
import .embeddings as emb
import .text_utils as tu



@dataclass
class ControllerImpl(ControllerInterface):
    designerName : str
# Here i basically want the prepping of the data to take place and then also the utilisation of the user query to generate embeddings. These will then be sent to the frontend to present to the user
# for this i need to split the controller into a function that preprepares the data and the embeddings and one that takes in the user query to give back the final recommendation.

#Data prepping and embedding
    
    def data_prep_and_embed():
        #load and preprocess
        df=pd.read_csv("data/articles.csv")
        model= emb.get_model(cf.SETTINGS.model_name)
        processed_df=pp.preprocess_articles(df)
        final_df= pp.get_value_from_description(precessed_df)
        designer_df=designer_dna.make_designer_df()
        #make corpus
        prepped_corpora=rc.PreparedCorpora.build_corpora(final_df, designer_df)

        #generate embeddings
        df_embeddings=emb.encode_texts(prepped_corpora.items_text, model)
        designer_embeddings=emb.encode_texts(prepped_corpora.designer_text, model)

        #calc similarity and attach as new column to the original df
        df_with_designer_recommendations= rc.PreparedCorpora.attach_compatible_designers(final_df, df_embeddings, designer_embeddings, designer_df.index)

        return df_with_designer_recommendations


    def generate_recommendation(user_query,df):
        df_corpus= rc.PreparedCorpora.build_corpora(df)
        user_recommendations_dict= rc.recommend_from_query(user_query, model_used,df, df_corpus.items_text)
        return user_recommendations_dict["designers"]








